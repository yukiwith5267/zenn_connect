---
title: "朝風呂に入りながらzoomを自動退出したい"
emoji: "😽"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [python, zoom]
published: True
---

## 動機

ギリギリまで睡眠時間を確保したかった。


## 実行環境
- OS: macOS Ventura Version13.2.1 (M1チップ)
- Python 3.11.4

## ソースコード

```python
import subprocess
import time

def join_zoom_meeting(meeting_id, password):
    command = f"zoommtg://zoom.us/join?action=join&confno={meeting_id}&pwd={password}"
    subprocess.call(["open", command])

def close_zoom_window():
    subprocess.call(["pkill", "zoom.us"])

def main():
    meeting_id = "YOUR_MEETING_ID"  # ミーティングIDをここに入力
    password = "YOUR_PASSWORD"     # パスワードをここに入力
    target_time = "10:30:00"  # 開始する時間を指定 (24時間形式)
    meeting_duration = 87  # ミーティングの持続時間を指定 (分単位)

    while True:
        current_time = time.strftime("%H:%M:%S")
        if current_time >= target_time:
            join_zoom_meeting(meeting_id, password)
            time.sleep(meeting_duration * 60)  # 分単位から秒単位に変換
            close_zoom_window()
            break
        else:
            time.sleep(1)

if __name__ == "__main__":
    main()
```
ソースコード内の`meeting_id`と`password`は自分のものに置き換えてください。
上記では、10:30:00にミーティングに参加し、87分後にミーティングから退出するようになっています。

## 追加
授業スライドを自動スクリーンショットするような機能を追加したいと思った。(まだ試行錯誤中)

具体的には、OpenCVで動体検知して、例えば画面全体の5割が変化したら、スクショをするような感じ。

```python
import subprocess
import time
import cv2
import numpy as np
from PIL import ImageGrab

# スクリーンショット保存先のディレクトリパス
SCREENSHOT_DIR = "/screenshot/zoom"

# 動体検知のしきい値（画面全体の変化の割合）
MOTION_THRESHOLD = 0.5

def join_zoom_meeting(meeting_id, password):
    command = f"zoommtg://zoom.us/join?action=join&confno={meeting_id}&pwd={password}"
    subprocess.call(["open", command])

def close_zoom_window():
    subprocess.call(["pkill", "zoom.us"])

def capture_screenshot():
    screenshot = ImageGrab.grab()
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    screenshot_path = f"{SCREENSHOT_DIR}/screenshot_{timestamp}.png"
    screenshot.save(screenshot_path)
    print(f"Screenshot saved: {screenshot_path}")

def main():
    meeting_id = "YOUR_MEETING_ID"  # ミーティングIDをここに入力
    password = "YOUR_PASSWORD"     # パスワードをここに入力
    target_time = "10:30:00"  # 開始する時間を指定 (24時間形式)
    meeting_duration = 1  # ミーティングの持続時間を指定 (分単位)
    motion_frames = []
    
    while True:
        current_time = time.strftime("%H:%M:%S")
        if current_time >= target_time:
            join_zoom_meeting(meeting_id, password)
            start_time = time.time()
            
            while True:
                # スクリーンショットを取得し、前回のフレームと比較する
                screenshot = np.array(ImageGrab.grab())
                gray = cv2.cvtColor(screenshot, cv2.COLOR_BGR2GRAY)
                gray = cv2.GaussianBlur(gray, (21, 21), 0)
                
                if len(motion_frames) < 2:
                    motion_frames.append(gray)
                    continue
                
                frame_delta = cv2.absdiff(motion_frames[0], gray)
                thresh = cv2.threshold(frame_delta, 30, 255, cv2.THRESH_BINARY)[1]
                thresh = cv2.dilate(thresh, None, iterations=2)
                contours, _ = cv2.findContours(thresh.copy(), cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
                motion_detected = False
                
                for contour in contours:
                    if cv2.contourArea(contour) > 500:
                        motion_detected = True
                        break
                
                if motion_detected:
                    motion_frames.pop(0)
                    motion_frames.append(gray)
                    elapsed_time = time.time() - start_time
                    
                    if elapsed_time >= meeting_duration * 60:
                        capture_screenshot()
                        close_zoom_window()
                        break
                else:
                    motion_frames.pop(0)
                    motion_frames.append(gray)
                
                time.sleep(0.1)
            
            break
        else:
            time.sleep(1)

if __name__ == "__main__":
    main()
```
まだ、動作確認はできていませえん。
コメントお待ちしています。

## 参考・使ったもの
ChatGPTくん